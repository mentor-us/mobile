name: Deploy to Google Play

on:
  push:
    branches:
      - "feature/MU-55-Fix-cicd-deploy-gg-play"

  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: "./src"
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Java 11
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "11"
          cache: "gradle"
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          working-directory: src
          ruby-version: '3.2'
          bundler-cache: true

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn cache dir)" >> "$GITHUB_OUTPUT"

      - name: Get Cache node_modules
        uses: actions/cache@v2
        id: yarn-cache
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install yarn dependencies
        run: yarn install --frozen-lockfile
      
      - name: Make Gradlew Executable
        run: cd android && chmod +x ./gradlew

      - name: Decode Keystore File
        uses: timheuer/base64-to-file@v1
        id: android_keystore
        with:
          fileName: "android_release.jks"
          encodedString: ${{ secrets.KEYSTORE_FILE }}
      
      - name: Build Android App Bundle Release
        run: yarn android:fastlane:buildRelease
        env: 
          ANDROID_KEYSTORE_PASSWORD: ${{secrets.KEY_PASSWORD }}
          ANDROID_KEYSTORE_ALIAS: ${{ secrets.KEY_ALIAS }}
          ANDROID_KEYSTORE_FILE: ${{ steps.android_keystore.outputs.filePath }}

      - name: Check release files
        run: ls -R ./src/android/app/build/outputs/bundle/release
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v2
        with:
          name: aab
          path: |
            ${{ github.workspace }}/src/android/app/build/outputs/bundle/release
  
  deploy_production:
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: "./src"
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        id: aab_artifact
        with:
          name: aab

      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          working-directory: src
          ruby-version: '3.2'
          bundler-cache: true
      
      - name: Decode Google Services JSON File
        uses: timheuer/base64-to-file@v1
        id: service_account_json_file
        with:
          fileName: "mentorus-mobile.json"
          encodedString: ${{ secrets.MENTORUS_MOBILE_JSON_KEY }}

      - name: Upload AAB to Google Play Store
        run: yarn android:fastlane:uploadRelease
        env:
          PLAY_STORE_JSON_KEY: ${{ steps.service_account_json_file.outputs.filePath }}
          PLAY_STORE_PACKAGE_NAME: com.mentorus
          PLAY_STORE_AAB_FILE: ${{steps.aab_artifact.outputs.download-path}}